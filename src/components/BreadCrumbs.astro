---

// Imports
import { getEntry } from 'astro:content';

// BreadCrumb paths
const { pathname } = Astro.url;
const parts = pathname.split("/").filter(Boolean);

// Filter out the 'middleman' routes
const filteredParts = parts.filter(part => !['clan', 'bloodline', 'non-clan'].includes(part));

function prettyCrumb(crumb: string) {
    return crumb
        .replace(/-/g, " ")
        .replace(/\b\w/g, (l) => l.toUpperCase());
}

// Resolve names from Content Collections
const crumbs = await Promise.all(filteredParts.map(async (part, i) => {
    const originalIdx = parts.indexOf(part);
    const to = "/" + parts.slice(0, originalIdx + 1).join("/");
    
    let displayName = prettyCrumb(part);

    // Try to find if this part is a Clan
    const clanEntry = await getEntry('clans', part);
    if (clanEntry) {
        displayName = clanEntry.data.name;
    } else {
        // Find Character Entry
        // We look for characters. Astro 5 IDs are usually 'folder/slug'
        const charEntry = await getEntry('characters', `${parts[originalIdx-1]}/${part}`);
        if (charEntry) {
            displayName = charEntry.data.name;
        }
    }

    return { name: displayName, to };
}));

---

<nav class="overflow-x-auto flex items-center gap-1 w-full whitespace-nowrap text-xs sm:gap-2 sm:text-sm" transition:name="breadcrumbs">
    
    <!-- Home Crumb -->
    <a 
        href="/" 
        class=`min-w-fit px-2 py-1 pt-1 w-fit rounded-full transition sm:px-3 ${parts.length === 0 ? "italic bg-bg-accent dark:bg-bg-accent-dark text-text-accent" : "text-text-secondary dark:text-text-secondary-dark bg-bg-secondary dark:bg-bg-secondary-dark hover:italic hover:text-text-primary dark:hover:text-text-primary-dark hover:bg-bg-tertiary dark:hover:bg-bg-tertiary-dark"}`
    >
        Home
    </a>

    {crumbs.map((crumb, i) => {
        const isLast = i === crumbs.length - 1;

        return (
            <div class="flex items-center gap-1 sm:gap-2">
                {/* Separators */}
                <img src="/assets/icons/chevron-right.png" class="w-3 sm:w-4 dark:hidden" alt="" />
                <img src="/assets/icons/chevron-right_light.png" class="w-3 sm:w-4 hidden dark:block" alt="" />

                {isLast ? (
                    // Active crumb
                    <span class="px-2 py-1 pt-1 italic bg-bg-accent dark:bg-bg-accent-dark text-text-accent rounded-full sm:px-3">
                        {crumb.name}
                    </span>
                ) : (
                    // Non-active crumb
                    <a href={crumb.to} class="min-w-fit px-2 py-1 pt-1 rounded-full transition sm:px-3 text-text-secondary dark:text-text-secondary-dark bg-bg-secondary dark:bg-bg-secondary-dark hover:italic hover:text-text-primary dark:hover:text-text-primary-dark hover:bg-bg-tertiary dark:hover:bg-bg-tertiary-dark">
                        {crumb.name}
                    </a>
                )}
            </div>
        )
    })}
</nav>